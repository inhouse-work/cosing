#!/usr/bin/env ruby
# frozen_string_literal: true

# Script used for cleaning the ingredients CSV file
# It removes duplicates and keeps the latest update for each ingredient
require "csv"
require "bundler/setup"
require "cosing"
require "debug"

ingredients = {}

Normalize = ->(name) do
  name
    .upcase
    .tr("\\", "/")
    .tr("-", " ")
    .gsub(/[\(\)]/, "")
    .split
    .map(&:strip)
    .compact
    .reject(&:empty?)
    .join(" ")
end

CSV.parse(
  File.read(Cosing.gem_path("data/ingredients.csv")),
  headers: true,
  liberal_parsing: true,
  header_converters: :symbol
).each do |row|
  inci_name = Normalize.call(row[:inci_name].strip)

  if data = ingredients[inci_name]
    if Date.parse(data[:update_date]) < Date.parse(row[:update_date])
      ingredients[inci_name] = row.to_h
    end
  else
    ingredients[inci_name] = row.to_h
  end

rescue Date::Error
  debugger
end

debugger

csv = CSV.generate do |csv|
  csv << ingredients.values.first.keys
  ingredients.values.each do |row|
    csv << row.values
  end
end

File.write(Cosing.gem_path("data/ingredients-v2.csv"), csv)
